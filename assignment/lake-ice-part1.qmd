---
title: "Lake Ice Phenology: Part 1"
author: 'Harsheel Dhruva'
format:
  html:
    embed-resources: true
---

## GitHub link

Provide link to your assignment GitHub repository here:

https://github.com/frec-3044-spring26/assignment-4-H-Dhruva.git

# Data

The data for this module are provided within the GitHub repository in the `data` sub-directory.

-   Data: `data/lake_ice_off_data.xlsx`

# Import and Prep

The data are in a multi-sheet Excel file named `data/lake_ice_off_data.xlsx`. You will need to use the `read_excel()` function in the `readxl` package to import the data into R as a data frame. You can learn more about importing from Excel [here](https://r4ds.hadley.nz/spreadsheets.html#prerequisites).  
For some reason, `read_excel()` does not like relative paths, so we will use the `here` package to locate your project on your computer. First, install the `here` package.  Then, run the `here()` function to get the path to your project.  Using `file.path()` appends the results of `here()` to the location of the data within your project/GitHub repository.

```{r}
library(here)
file_name <- file.path(here(),"data/lake_ice_off_data.xlsx")
```

Now use `read_excel()` to read in `file_name`. Remember that Excel files can have multiple sheets.

```{r}
library(readxl)

ice_off_data <- read_excel(file_name, sheet = 2)
```

Now, look at a preview of the data using the `head()` function. The `doy` in `ice_off_doy` stands for "day of the year" and is the day within the year where ice off occurred (January 1 = doy 1).  `did_not_freeze` is a column where 1 = did not freeze and 0 = did freeze.

```{r}
head(ice_off_data)
```

There should be four columns and \~2703 rows.

## Tidy the data

We will practice key skills in the module using a focal lake. Use the `filter` function to filter the more extensive data to only contain the data from Lake Sunapee, a lake in New Hampshire. Filter the data `ice_data` by the variable `lake_name` to create a data frame called `sunapee`.

```{r}
library(tidyverse)

sunapee <- ice_off_data |>
  filter(lake_name == "Sunapee") |>
  mutate(ice_off_doy = as.numeric(ice_off_doy))
```

You will be using the `sunapee` data for the rest of the module until Question 11

## Visualize the data

**Question 1:**

To visualize the data from Lake Sunapee, create an x-y plot with the year (`year`) on the x-axis and the day of the year (`ice_off_doy`) on the y-axis. Plot the points (`geom_point`) and connect the points with lines (`geom_line`). 

Be sure that the title, x-axis, and y-axis labels are clearly labeled.

**Answer 1:**

```{r}
library(ggplot2)

ggplot(sunapee, aes(x = year, y = ice_off_doy)) +
  geom_point() +
  geom_line(color = "navyblue") +
  labs( title = "Sunapee Ice-Off Day of Year Over Time",
    x = "Year",
    y = "Ice-Off Day of Year") +
  theme_bw()
```

# How does ice cover change over time at Lake Sunapee?

We want to model how the ice-off date changes over time. Our approach in this module is to use a linear regression that predicts the ice-off day of year as a function of the year. The `lm` function will estimate the parameters of the DOY = b + m \* YEAR linear regression where b is the intercept and m is the slope.

**Question 2:**

What do you expect the sign (plus, minus, or no change) to be for the slope of the relationship? Why?

We expect a negative slope for the relationship, as when the climate warms over time, we can expect lakes to have the ice melt earlier in the year. Additionally, the negative slope would be representiative of the downward trend of ice off days presented in the plot from question 1. Since earlier dates correspond to smaller day of year values, increasing year should correspond to decreasing ice-off day of year.

**Answer 2:**

Use the `lm` function to predict `ice_off_doy` as a function (`~`) of the year for the data.frame called `sunapee`. You can learn more about the `lm` function [here](https://www.datacamp.com/tutorial/linear-regression-R)

Create an object called `fit` that contains the results of the linear model.

```{r}
fit <- lm(ice_off_doy ~ year, data = sunapee)
```

Then, use the function `summary` to explore the result of the `lm` function.

```{r}
summary(fit)
```

The results of your linear model are in an object named `fit`, so you can find the regression coefficients at `fit$coefficients[1]` (the intercept) and `fit$coefficients[2]` (the slope). Confirm that `fit$coefficients[1]` and `fit$coefficients[2]` match the values expected from the summary command you ran above.

```{r}
fit$coefficients[1]
fit$coefficients[2]
```
The coefficients for the intercept, `R fit$coefficients[1]`, and the slope, `R fit$coefficients[2]`, match the values presented in the summary command. 

**Question 3:**

What is the direction of the slope? How does this match your expectations from Question 2?

**Answer 3:**

The slope is negative (-0.1060227), indicating that ice-off dates are occurring in the year earlier over time, which matches our expectations from Question 2 directly.

# Is our model any good?

## R2

First, it is important to understand how much variation is explained by the model using the R2 value in the `summary`. A value of R2 close to 1 means that the predictor (`year`) explains nearly all of the variation in the variable we are predicting: `ice_off_doy`. A value of R2 close to 0 explains very little of the variation in `ice_off_doy`. Since we want to be able to explain how `ice_off_doy` is changing over time using `year,` we are aiming for a high R2. A low R2 would indicate that our model isn't particularly good at explaining what future values of `ice_off_doy` will be.

**Question 4:**

What is the R2 for the regression? Based on the R2, is `year` and `ice_off_doy` strongly related?

**Answer 4:**

The R2 for the regression is 0.2055. Based on the fact that for environmental data trends that a R2 of 0.3 is considered good enough, we would believe that the `year` and `ice_off_doy` are not strongly related. 

## Residuals normally distributed

Second, it is important that the residuals from our linear model are normally distributed. The following is a normal distribution that you can visually compare to:

```{r}
ggplot(data = tibble(value = rnorm(1000, 0, 1))) +
  geom_histogram(aes(x = value), bins = 20)
```

We will use a histogram to visually assess whether this requirement is met. First, you will need to calculate the residuals. The residuals are the difference between the ice-off DOY that your linear regression predicts and the observed DOY.

-   Residuals that do not average to zero indicate that your linear regression is biased.

-   Residuals that are widely spread out indicate that your linear regression is not very useful for prediction.

You will use a histogram to examine the residuals. First, the code uses the coefficients to predict the yearly ice-off DOY. Second, calculate the residuals by subtracting the predicted ice-off DOY from the observed DOY.

```{r}
sunapee <- sunapee %>% 
  mutate(predicted = fit$coefficients[1] + year * fit$coefficients[2], 
         residual = ice_off_doy - predicted) #Observed - Predicted
```

**Question 5:**

Use the [`add_predictions()`](https://modelr.tidyverse.org/reference/add_predictions.html) and [`add_residuals()`](https://modelr.tidyverse.org/reference/add_residuals.html) functions from the `modelr` package (installs with the tidyverse but you need to load it with ` library()`) to add the predictions and residuals. This accomplishes the same thing above but doesn't require you to specifically write our your model with the coefficients (thus is more scalable to other models)

**Answer 5:**

```{r}
library(modelr)

sunapee <- sunapee |>
  add_predictions(fit) |>
  add_residuals(fit)

head(sunapee)
```

Now, to visualize the residuals, use `geom_histogram()` to plot them as a histogram. I recommend using a bin width of 10 in the histogram.

**Question 6:**

Show Histogram and answer the following question: do the residuals meet the assumptions of the linear regression? (are the residuals normally distributed with the distribution centered around zero)?

**Answer 6:**

```{r}
ggplot(sunapee, aes(x = resid)) +
  geom_histogram(binwidth = 10, color = "black", fill = "skyblue") +
  labs(title = "Histogram of Sunapee Residuals",
       x = "Residual",
       y = "Frequency") +
  theme_bw()
```

From the histogram, we observe a genral unimodal peak of the count for the residuals centered around 0, in a pattern representative of a normal distribution. Hence, the residuals do meet the assumptions for a linear regression. 


## The slope is different from zero

A slope could appear to be higher or lower than zero, but the uncertainty in the slope is large enough that there is a chance that the slope value is 0 (thus limiting our capacity to believe the value for the slope is not zero). Here, we will focus on the p-value of the slope. The p-value is the probability of obtaining a slope at least as extreme as the one calculated from the data, assuming the truth of the null hypothesis that the slope is 0 (from <https://en.wikipedia.org/wiki/P-value>). In this case, what is the probability of observing our slope value assuming the actual slope is 0? Smaller probabilities mean there is a lower chance that our slope is equal to 0.

**Question 7:**

Based on the `summary()` above, what is the p-value for the slope?

**Answer 7:**

The p-value for the slope is 2.5e-09. 

## The slope physically meaningful

A slope value could have a low probability of being 0 (thus we have a strong belief that it is not zero), but the magnitude of change is functionally meaningless in the physical world (i.e., the rate of change is so small that we would not think much of it). This can occur particularly when analyzing large datasets.

**Question 8:**

Based on the slope value, how many more years are needed to pass before the lake has a 1 week change in ice off doy? Do you think this is meaningful? Why?

**Answer 8:**

$$
y = mx + b, \quad y = \text{Day of year} \quad x = \text{Year}
$$
From the linear regression model:
$$
m = -0.1060227, \quad  b = 318.9486
$$
$$
\therefore \quad y = 318.9486 - 0.1060227x
$$

Let a week decrease in ice off day be represented as:
$$
\Delta y =  y_1 - y_0 = -7
$$
$$
\therefore \quad  318.9486 - 0.1060227x_1 - (318.9486 - 0.1060227x_0) = -7
$$
$$
 - 0.1060227x_1 + 0.1060227x_0 = -7
$$
$$
 - 0.1060227x_1 + 0.1060227x_0 = -7
$$
$$
 x_1 - x_0 = \Delta x \approx 66.0235
$$

Based on the slope value, approximately 66.0236 years are needed to pass before the lake has a 1 week change in ice off day of year. I think this is meaningful because it reflects a persistent, low-frequency climate signal accumulating over decades. This gradual accumulation can be worse in practice as when melting occurs from under the ice, the water below gets more access to energy from light the would have otherwise been reflected. As a result, the melting will speed up and worsen in ways that our linear model does not reflect. Additionally, this warmer water will have less capacity to carry dissolved oxygen, which is bad for the cold-water fish and can lead to increase in phosphorus and reduced metals cycling within the sediment. 

## Overall model assessment

**Question 9:**

How comfortable are you proceeding with using this linear model for additional analysis and prediction? Why? (I am not looking for your gut answer, rather I want you to apply concepts taught in this module to justify your answer)

**Answer 9:**
I would say that I am moderately comfortable using this linear model for the descriptive trend analysis and prediction, but I will be cautious. For descriptive analysis, the linear regression does give a statistically significant slope (p = 2.5e-09), and the residuals of the model are approximately normal. Hence, the linear regression can be trusted for representing generalized long-term trends. However, the raw data demonstrates that there is a lot of variability from year to year, with large spikes/swings in the pattern of points, and the R2 value of the relationship between year and the ice of day of year is very low (0.2055), which leads me to be cautious of the results as they may not adequately represent for the variability or other influences.

**Question 10:**
Now plot the data for Lake Sunapee (just like above - year on x-axis vs. ice of doy on y axis) but add the line from your regression results (e.g., fit intercept and slope). You will use the [`geom_abline`](https://ggplot2.tidyverse.org/reference/geom_abline.html). 

**Answer 10:**
```{r}
ggplot(sunapee, aes(x = year, y = ice_off_doy)) +
  geom_point() +
  geom_line() +
  geom_abline(intercept = fit$coefficients[1],
              slope = fit$coefficients[2],
              color = "red") +
  labs(title = "Sunapee Ice-Off Day of Year - Regression Line",
       x = "Year",
       y = "Ice-Off Day of Year") +
  theme_bw()
```

**Question 11:**

The goal of this question is to make a forecast of the future ice-off day (with uncertainty estimate) using your model.

- Use the regression model to predict the ice-off day of the year in 2040 (provide answer). Remember that year is in the linear model (y = b + mx).  
- Calculate the 90% confidence interval by using the`quantile` function to determine the 5% and 95% quantile for your residuals in Question 6 (the 5% should be a negative number and the 95% should be a positive number because your residuals are centered around 0).  You will use the vector of residuals from Question 6 in your calculation.
- Add lower confidence interval (a negative number) and the upper confidence interval (a positive number) to your prediction for 2040 to calculate the 90% confidence interval around your prediction (provide your answer). 
- How wide is your confidence interval (number of days)?

**Answer 11:**

```{r}
print("Prediction Ice-off Day of Year in 2040:")
pred_2040 <- fit$coefficients[1] + fit$coefficients[2] * 2040
pred_2040

q <- quantile(sunapee$resid, probs = c(0.05, 0.95), na.rm = T)
print("Confidence Interval:")
ci_2040 <- pred_2040 + q
ci_2040

print("Interval Width:")
width <- ci_2040[2] - ci_2040[1]
width
```

$$
y = 318.9486 - 0.1060227x, \quad y = \text{Day of year} \quad x = \text{Year}
$$

Let x = 2040:

$$
y = 318.9486 - 0.1060227(2040) \approx 102.662
$$
The linear regression model predicts that in the year 2040, the ice off day of year will be approximately 102.6622. 

We estimate with 90% confidence that the predicted value for the ice-off day of year in 2040 will be between 83.23486 and 116.81355 days. 

The interval is 33.57868 days wide.

# Is the ice-off day of the year changing more quickly in more recent years at Lake Sunapee?

To answer this question, you need to divide the Sunapee dataset into two datasets that represent an early and later period. For this analysis, use the year 1970 as a cut-off (one dataset is before 1970, and the other is 1970 and after).

**Question 12:**

Use the skills developed above to evaluate the question "Is the ice-off day of year changing more quickly in more recent years at Lake Sunapee?"

Use a mix of code, figures, and text to present your analysis.  If you want to compare slopes, be sure they are on the same plot.

**Answer 12:**

```{r}
sunapee_pre1970  <- subset(sunapee, year < 1970)
sunapee_post1970 <- subset(sunapee, year >= 1970)

fit_pre1970  <- lm(ice_off_doy ~ year, data = sunapee_pre1970)
fit_post1970 <- lm(ice_off_doy ~ year, data = sunapee_post1970)

sunapee_pre1970$pred  <- predict(fit_pre1970)
sunapee_post1970$pred <- predict(fit_post1970)

print("Linear Regression Model of Sunapee Before 1970:")
summary(fit_pre1970)

print("Linear Regression Model of Sunapee After 1970:")
summary(fit_post1970)

print("Linear Regression Slope Sunapee Before 1970:")
coef(fit_pre1970)[2]
print("Linear Regression Slope Sunapee After 1970:")
coef(fit_post1970)[2]


sunapee_pre1970$period  <- "Pre-1970"
sunapee_post1970$period <- "Post-1970"
plot_data <- bind_rows(sunapee_pre1970, sunapee_post1970)

ggplot(plot_data, aes(x = year, y = ice_off_doy, color = period)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(y = pred)) +
  labs(title = "Sunapee Ice-Off Day Trends Pre-1970 vs Post-1970",
       x = "Year",
       y = "Ice-Off Day of Year",
       color = "Period") +
  theme_bw()
```

Upon fitting linear regression models to two subsets of the Sunapee Ice-off data set by years before 1970 and years from 1970 onward, we can observe the slopes and R2 values of each model

For the pre-1970 data, the fitted model produced a slope of $m_{\text{pre 1970}} = −0.10967$ days per year (p=0.00108). This indicates a statistically significant trend for earlier ice-off days to years prior 1970.

For the post-1970 period, the fitted slope was $m_{\text{post1970}} = −0.30239$ days per year (p=0.000161). This also corresponds to a statistically significant trend for earlier ice-off days to years of 1970 and after. However, the slope magnitude of the post-1970 trend is approximately 2.8 times stronger in magnitude than the pre-1970 model.

Additionally, the post-1970 model explains more variability in ice-off timing (R2 = 0.2336) compared to the pre-1970 model (R2 = 0.1027), suggesting a stronger linear signal after 1970.

Although both periods show statistically significant trends toward earlier ice-off dates, the slope after 1970 is much steeper and the proportion of variance explained by year increased from 10.3% before 1970 to 23.4% after 1970, indicating that the rate at which ice-off is advancing has accelerated in the post-1970 era. The diagram also demonstrates a steeper decline in the day of year for ice off after 1970 compared to before. This all suggests that the ice-off day of year has been occurring more rapidly at Lake Sunepee recently.

# Rendering and committing

Remember to Render your document as HTML and comment+push to GitHub your code and rendered HTML that was created when you rendered the document. Your GitHub repository should have multiple commits with informative commit messages.

# Citation of model

This module was initially developed as an Excel-based activity by Carey, C.C., J.L. Klug, and D.C. Richardson. 1 April 2015. Project EDDIE: Lake Ice Phenology. Project EDDIE Module 1, Version 1: <http://cemast.illinoisstate.edu/data-for-students/modules/ice-phenology.shtml>. Module development was supported by NSF DEB 1245707.

# Attribution

Include citation of any AI-generated assistance or discussion with classmates (per policy in syllabus). Proper documentation of AI-generated assistance includes the prompt, the source (e.g., ChatGPT), and the significant parts of the response.  Proper documentation of discussion with classmates include listing their names and the components discussed.  

